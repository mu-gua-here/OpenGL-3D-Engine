name: Build and Deploy Engine to Itch.io

on:
  push:
    branches: [ main ] # Trigger on pushes to main branch

jobs:

  # 1. LINUX BUILD JOB

  build_linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies (Linux)
        run: sudo apt-get update && sudo apt-get install -y build-essential libgl-dev

      - name: Configure CMake (Linux)
        run: cmake -B build_linux -DCMAKE_BUILD_TYPE=Release "OpenGL 3D Engine"

      - name: Build Project (Linux)
        run: cmake --build build_linux --config Release
        
      - name: Package and Push to itch.io (Linux)
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          ITCH_USER: mu-gua-here
          ITCH_GAME: opengl-3d-engine-demo
          PACKAGE: build_linux/
          CHANNEL: linux
          VERSION: ${{ github.sha }}


  # 2. WINDOWS BUILD JOB

  build_windows:
    runs-on: windows-latest # GitHub-hosted Windows runner
    steps:
      - uses: actions/checkout@v4
            
      - name: Configure CMake (Windows)
        run: cmake -B build_windows -A x64 -DCMAKE_BUILD_TYPE=Release "OpenGL 3D Engine"

      - name: Build Project (Windows)
        run: cmake --build build_windows --config Release
        
      - name: Package and Push to itch.io (Windows)
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          ITCH_USER: mu-gua-here
          ITCH_GAME: opengl-3d-engine-demo
          PACKAGE: build_windows/Release/
          CHANNEL: windows
          VERSION: ${{ github.sha }}

  # 3. MACOS BUILD JOB

  build_macos:
    runs-on: macos-latest # GitHub-hosted macOS runner
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure CMake (macOS)
        # FIX: Point to the correct source directory
        run: cmake -B build_macos -G Xcode -DCMAKE_BUILD_TYPE=Release "OpenGL 3D Engine"
        
      - name: Build Project (macOS)
        run: cmake --build build_macos --config Release
        
      - name: Create DMG or ZIP Package (Recommended)
        # Your executable will likely be in the build_macos/Release/ folder
        run: zip -r OpenGL-3D-Engine.zip build_macos/Release/
        
      - name: Push to itch.io (macOS)
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          ITCH_USER: mu-gua-here
          ITCH_GAME: opengl-3d-engine-demo
          PACKAGE: OpenGL-3D-Engine.zip
          CHANNEL: osx
          VERSION: ${{ github.sha }}
