name: Build and Deploy Engine to Itch.io

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

env:
  ITCH_USER: mu-gua-here
  ITCH_GAME: opengl-3d-engine-demo

jobs:

  # 1. LINUX BUILD JOB
  build_linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libgl-dev \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libxext-dev \
            libwayland-dev \
            libxkbcommon-dev

      - name: Configure and Build (Linux)
        run: |
          cmake -S . -B build_linux \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_VERBOSE_MAKEFILE=ON
          cmake --build build_linux --config Release -j$(nproc)

      - name: Package Linux Build
        run: |
          mkdir -p dist/linux
          
          # Find binary
          BIN=$(find build_linux -type f -name 'OpenGL-3D-Engine' -executable | head -n1)
          
          if [ -z "$BIN" ]; then
            echo "ERROR: Binary not found"
            find build_linux -type f -executable
            exit 1
          fi
          
          echo "Found binary: $BIN"
          cp "$BIN" dist/linux/
          
          # Copy assets
          cp -r scene_models skyboxes dist/linux/
          
          # Create run script
          cat > dist/linux/run.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          ./OpenGL-3D-Engine
          EOF
          chmod +x dist/linux/run.sh
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: dist/linux/
          
      - name: Push to itch.io (Linux)
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          ITCH_USER: ${{ env.ITCH_USER }}
          ITCH_GAME: ${{ env.ITCH_GAME }}
          PACKAGE: dist/linux
          CHANNEL: linux
          VERSION: ${{ github.run_number }}


  # 2. WINDOWS BUILD JOB
  build_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg integrate install
          .\vcpkg install glfw3:x64-windows assimp:x64-windows --triplet x64-windows
          
      - name: Build (Windows)
        run: |
          $env:VCPKG_ROOT = "$pwd\vcpkg"
          cmake -S . -B build_windows `
            -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows
          cmake --build build_windows --config Release -- /m

      - name: Package Windows Build
        shell: bash
        run: |
          mkdir -p dist/windows
          
          # Find exe
          EXE=$(find build_windows -type f -name 'OpenGL-3D-Engine.exe' | head -n1)
          
          if [ -z "$EXE" ]; then
            echo "ERROR: Executable not found"
            find build_windows -name "*.exe"
            exit 1
          fi
          
          echo "Found exe: $EXE"
          cp "$EXE" dist/windows/
          
          # Copy DLLs
          find "$VCPKG_ROOT/installed/x64-windows/bin" -name "*.dll" \
            -exec cp {} dist/windows/ \; 2>/dev/null || true
          
          # Copy assets
          cp -r scene_models skyboxes dist/windows/
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/windows/
          
      - name: Push to itch.io (Windows)
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          ITCH_USER: ${{ env.ITCH_USER }}
          ITCH_GAME: ${{ env.ITCH_GAME }}
          PACKAGE: dist/windows
          CHANNEL: windows
          VERSION: ${{ github.run_number }}


  # 3. MACOS BUILD JOB
  build_macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies (macOS)
        run: |
          brew install glfw assimp
      
      - name: Configure and Build (macOS)
        run: |
          cmake -S . -B build_macos \
            -DCMAKE_BUILD_TYPE=Release \
            -DGLFW_LIBRARY=$(brew --prefix glfw)/lib/libglfw.dylib \
            -DGLFW_INCLUDE_DIR=$(brew --prefix glfw)/include \
            -DASSIMP_LIBRARY=$(brew --prefix assimp)/lib/libassimp.dylib \
            -DASSIMP_INCLUDE_DIR=$(brew --prefix assimp)/include
          cmake --build build_macos --config Release -j$(sysctl -n hw.ncpu)
        
      - name: Package macOS Build
        run: |
          mkdir -p dist/macos
          
          # Find binary
          BIN=$(find build_macos -type f -name 'OpenGL-3D-Engine' -perm +111 | head -n1)
          
          if [ -z "$BIN" ]; then
            echo "ERROR: Binary not found"
            find build_macos -type f -perm +111
            exit 1
          fi
          
          echo "Found binary: $BIN"
          cp "$BIN" dist/macos/
          
          # Copy dynamic libraries
          mkdir -p dist/macos/lib
          otool -L "$BIN" | grep '/opt/homebrew\|/usr/local' | \
            awk '{print $1}' | while read lib; do
            if [ -f "$lib" ]; then
              cp "$lib" dist/macos/lib/ || true
            fi
          done
          
          # Update library paths
          install_name_tool -add_rpath @executable_path/lib dist/macos/OpenGL-3D-Engine || true
          
          # Copy assets
          cp -r scene_models skyboxes dist/macos/
          
          # Create run script
          cat > dist/macos/run.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          export DYLD_LIBRARY_PATH="$PWD/lib:$DYLD_LIBRARY_PATH"
          ./OpenGL-3D-Engine
          EOF
          chmod +x dist/macos/run.sh
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: dist/macos/
          
      - name: Push to itch.io (macOS)
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          ITCH_USER: ${{ env.ITCH_USER }}
          ITCH_GAME: ${{ env.ITCH_GAME }}
          PACKAGE: dist/macos
          CHANNEL: osx
          VERSION: ${{ github.run_number }}