name: Build and Deploy Engine to Itch.io

on:
  push:
    branches: [ main ]

jobs:

  # 1. LINUX BUILD JOB

  build_linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies (Linux)
        run: sudo apt-get update && sudo apt-get install -y build-essential libgl-dev

      - name: Configure and Build (Linux)
        run: |
          set -euo pipefail
          mkdir -p dist/linux

          # Configure and build with CMake
          cmake -S . -B build_linux -DCMAKE_BUILD_TYPE=Release
          cmake --build build_linux -- -j$(nproc)

          # Find the binary (search in common CMake output locations)
          BIN=$(find build_linux/bin -type f -name 'OpenGL-3D-Engine' -perm /111 2>/dev/null | head -n1 || true)
          if [ -z "$BIN" ]; then
            BIN=$(find build_linux -type f -name 'OpenGL-3D-Engine' -perm /111 2>/dev/null | head -n1 || true)
          fi

          if [ -z "$BIN" ]; then
            echo "ERROR: Could not find built binary 'OpenGL-3D-Engine'." >&2
            echo "Build directory contents:"
            find build_linux -type f -perm /111 || true
            exit 1
          fi

          echo "Found binary at: $BIN"
          cp "$BIN" dist/linux/
          
          # Copy asset folders (scene_models and skyboxes)
          cp -r scene_models dist/linux/
          cp -r skyboxes dist/linux/
          
      - name: Push to itch.io (Linux)
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          ITCH_USER: mu-gua-here
          ITCH_GAME: opengl-3d-engine-demo
          PACKAGE: dist/linux
          CHANNEL: linux
          VERSION: ${{ github.ref_name }}-${{ github.sha }}


  # 2. WINDOWS BUILD JOB

  build_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
            
      - name: Build (Windows)
        shell: pwsh
        run: |
          # Build with CMake for Windows
          cmake -S . -B build_windows -G "Visual Studio 17 2022" -A x64
          cmake --build build_windows --config Release

      - name: Package Windows Build
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/windows

          # Search for the .exe in Release build output
          EXE=$(find build_windows/bin/Release -type f -name 'OpenGL-3D-Engine.exe' 2>/dev/null | head -n1 || true)
          if [ -z "$EXE" ]; then
            EXE=$(find build_windows -type f -name 'OpenGL-3D-Engine.exe' 2>/dev/null | head -n1 || true)
          fi

          if [ -z "$EXE" ]; then
            echo "ERROR: Could not find OpenGL-3D-Engine.exe" >&2
            echo "Build directory contents:"
            find build_windows -type f -name "*.exe" || true
            exit 1
          fi

          echo "Found exe at: $EXE"
          cp "$EXE" dist/windows/
          
          # Copy asset folders
          cp -r scene_models dist/windows/
          cp -r skyboxes dist/windows/
          
      - name: Push to itch.io (Windows)
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          ITCH_USER: mu-gua-here
          ITCH_GAME: opengl-3d-engine-demo
          PACKAGE: dist/windows
          CHANNEL: windows
          VERSION: ${{ github.ref_name }}-${{ github.sha }}


  # 3. MACOS BUILD JOB

  build_macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure and Build (macOS)
        run: |
          cmake -S . -B build_macos
          cmake --build build_macos --config Release
        
      - name: Package macOS Build
        run: |
          set -euo pipefail
          mkdir -p dist/macos
          
          # Find the macOS binary
          BIN=$(find build_macos/bin/Release -type f -name 'OpenGL-3D-Engine' 2>/dev/null | head -n1 || true)
          if [ -z "$BIN" ]; then
            BIN=$(find build_macos -type f -name 'OpenGL-3D-Engine' 2>/dev/null | head -n1 || true)
          fi
          
          if [ -z "$BIN" ]; then
            echo "ERROR: Could not find macOS binary" >&2
            echo "Build directory contents:"
            find build_macos -type f -perm +111 || true
            exit 1
          fi
          
          echo "Found binary at: $BIN"
          cp "$BIN" dist/macos/
          
          # Copy asset folders
          cp -r scene_models dist/macos/
          cp -r skyboxes dist/macos/

          cd dist/macos
          zip -r ../opengl-3d-engine-macos.zip .
          
      - name: Push to itch.io (macOS)
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          ITCH_USER: mu-gua-here
          ITCH_GAME: opengl-3d-engine-demo
          # Point the PACKAGE variable to the newly created zip file
          PACKAGE: dist/opengl-3d-engine-macos.zip
          # Use "macos" channel name for consistency
          CHANNEL: macos 
          VERSION: ${{ github.ref_name }}-${{ github.sha }}