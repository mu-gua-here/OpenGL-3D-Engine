name: Build and Deploy Engine to Itch.io

on:
  push:
    branches: [ main ]

jobs:

  # 1. LINUX BUILD JOB

  build_linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies (Linux)
        run: sudo apt-get update && sudo apt-get install -y build-essential libgl-dev

      - name: Configure and Build (Linux)
        run: |
          mkdir -p dist/linux
          cp build_linux/bin/OpenGL-3D-Engine dist/linux/
          cp -r assets shaders dist/linux/
          
      - name: Push to itch.io (Linux)
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          ITCH_USER: mu-gua-here
          ITCH_GAME: opengl-3d-engine-demo
          PACKAGE: dist/linux
          CHANNEL: linux
          VERSION: ${{ github.ref_name }}-${{ github.sha }}


  # 2. WINDOWS BUILD JOB

  build_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
            
      - name: Package Windows Build
        run: |
          mkdir -p dist/windows
          cp build_windows/Release/OpenGL-3D-Engine.exe dist/windows/
          cp -r assets shaders dist/windows/
          
      - name: Push to itch.io (Windows)
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          ITCH_USER: mu-gua-here
          ITCH_GAME: opengl-3d-engine-demo
          PACKAGE: dist/windows
          CHANNEL: windows
          VERSION: ${{ github.ref_name }}-${{ github.sha }}


  # 3. MACOS BUILD JOB

  build_macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure and Build (macOS)
        run: |
          cmake -B build_macos -G Xcode -DCMAKE_BUILD_TYPE=Release .
          cmake --build build_macos --config Release
        
      - name: Package macOS Build
        run: |
          mkdir -p dist/macos
          cp build_macos/Release/OpenGL-3D-Engine dist/macos/
          cp -r assets shaders dist/macos/
          
      - name: Push to itch.io (macOS)
        run: |
          butler push dist/macos mu-gua-here/opengl-3d-engine-demo:osx \
            --userversion ${{ github.ref_name }}-${{ github.sha }}
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
