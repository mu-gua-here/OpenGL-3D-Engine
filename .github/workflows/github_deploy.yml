name: Deploy Engine to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Emscripten
        run: |
          git clone https://github.com/emscripten-core/emsdk.git
          cd emsdk
          ./emsdk install latest
          ./emsdk activate latest

      - name: Build WebAssembly
        run: |
          # Install zlib for Assimp
          sudo apt-get update
          sudo apt-get install -y zlib1g-dev
          
          source emsdk/emsdk_env.sh
          mkdir -p build-web
          cd build-web
          emcmake cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXECUTABLE_SUFFIX=".html"
          emmake make -j$(nproc)

      - name: Prepare deployment directory
        run: |
          mkdir -p deploy
          
          # Find where the files actually are
          echo "=== Searching for build output ==="
          find build-web -name "*.html" -o -name "*.js" -o -name "*.wasm" -o -name "*.data"
          
          # Files are in build-web/bin/Release/
          BUILD_DIR="build-web/bin/Release"
          
          if [ ! -d "$BUILD_DIR" ]; then
            echo "ERROR: $BUILD_DIR does not exist!"
            ls -la build-web/
            exit 1
          fi
          
          echo "Found build directory: $BUILD_DIR"
          ls -lh "$BUILD_DIR"
          
          # Copy ALL files with exact names
          cp "$BUILD_DIR/OpenGL-3D-Engine.html" deploy/index.html
          cp "$BUILD_DIR/OpenGL-3D-Engine.js" deploy/OpenGL-3D-Engine.js
          cp "$BUILD_DIR/OpenGL-3D-Engine.wasm" deploy/OpenGL-3D-Engine.wasm
          cp "$BUILD_DIR/OpenGL-3D-Engine.data" deploy/OpenGL-3D-Engine.data
          
          echo "=== Deployment directory contents ==="
          ls -lh deploy/
          du -sh deploy/*.data
          
      - name: List deployment files
        run: |
          echo "=== Deployment directory contents ==="
          ls -lh deploy/
          echo ""
          echo "=== Checking for .data file specifically ==="
          find deploy/ -name "*.data" -exec ls -lh {} \;
          echo ""
          echo "=== Total size of deploy directory ==="
          du -sh deploy/
          echo ""
          echo "=== Verifying file types ==="
          file deploy/* 2>/dev/null || echo "Could not determine file types"

      - name: Setup Git LFS
        run: |
          git lfs install
          git lfs track "*.data"

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy/
          retention-days: 1

  deploy:
    needs: build-web
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4